name: dka-microservices-parking-config

services:

  app:
    build:
      context: .
    profiles:
      - app
    container_name: dka-microservices-parking-config-app
    hostname: config.parking.services.dkaapis.com
    working_dir: /home/app
    environment:
      DKA_DB_MONGO_HOST: db.config.parking.services.dkaapis.com
      DKA_DB_MONGO_USERNAME: developer
      DKA_DB_MONGO_PASSWORD: Cyberhack2010
      DKA_DB_MONGO_DATABASE: dka-parking-config
      # -----------------------------------------------------------------
      DKA_SERVER_HOST: 0.0.0.0
      DKA_SERVER_PORT: 80
      # -----------------------------------------------------------------
      DKA_HOST_ACCOUNT_SERVICE: account.services.dkaapis.com
      DKA_PORT_ACCOUNT_SERVICE: 80
      # -----------------------------------------------------------------
      # -----------------------------------------------------------------
      DKA_MQTT_BROKER_CLIENT_ID: dka-parking-config
      DKA_MQTT_BROKER_PROTOCOL: mqtt
      DKA_MQTT_BROKER_HOST: mqtt.dkaapis.com
      DKA_MQTT_BROKER_PORT: 1883
      # -----------------------------------------------------------------
    deploy:
      resources:
        limits:
          memory: 400M
        reservations:
          memory: 200M
    restart: always
    volumes:
      - type: volume
        source: parking-config-app-data
        target: /home/app
      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true
      - type: bind
        source: /etc/timezone
        target: /etc/timezone
        read_only: true

    command: yarn run start:prod
    networks:
      - dka-microservices-parking-config-network
      - dka-microservice-external

  mongo:
    image: mongo:latest
    profiles:
      - db
    container_name: dka-microservices-parking-config-mongo
    hostname: db.config.parking.services.dkaapis.com
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: developer
      MONGO_INITDB_ROOT_PASSWORD: Cyberhack2010
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 300M
        reservations:
          cpus: '0.25'
          memory: 100M
    volumes:
      - type: volume
        source: mongodb-data
        target: /data/db
      - type: bind
        source: ./.config/mongo/mongod.conf
        target: /etc/mongod.conf
        read_only: true
      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true
      - type: bind
        source: /etc/timezone
        target: /etc/timezone
        read_only: true
    command: mongod --config /etc/mongod.conf
    networks:
      - dka-microservices-parking-config-network

volumes:
  parking-config-app-data:
    driver: local
  mongodb-data:
    driver: local
  dka-ssl-data:
    driver: local

networks:
  dka-microservices-parking-config-network:
    driver: bridge
  dka-microservice-external:
    external: true